<div class="price-history-container">
  <!-- Header -->
  <div class="price-history-header">
    <h3>
      <nz-icon nzType="line-chart" nzTheme="outline"></nz-icon>
      Price History
      <span *ngIf="productName" class="product-name">- {{ productName }}</span>
    </h3>

    <div class="header-actions">
      <button nz-button nzType="default" nzSize="small" (click)="toggleChart()">
        <nz-icon [nzType]="showChart ? 'eye-invisible' : 'eye'" nzTheme="outline"></nz-icon>
        {{ showChart ? 'Hide' : 'Show' }} Chart
      </button>
      <button nz-button nzType="primary" nzSize="small" (click)="exportData()">
        <nz-icon nzType="download" nzTheme="outline"></nz-icon>
        Export
      </button>
    </div>
  </div>

  <!-- Price Statistics -->
  <nz-card nzSize="small" class="stats-card" [nzLoading]="statsLoading">
    <div nz-row [nzGutter]="16" *ngIf="priceStats">
      <div nz-col [nzSpan]="6">
        <nz-statistic
          [nzValue]="priceStats.currentPrice"
          [nzTitle]="'Current Price'"
          [nzFormatter]="formatCurrency">
        </nz-statistic>
      </div>
      <div nz-col [nzSpan]="6">
        <nz-statistic
          [nzValue]="priceStats.lowestPrice"
          [nzTitle]="'Lowest Price'"
          [nzFormatter]="formatCurrency"
          [nzValueStyle]="{ color: '#52c41a' }">
        </nz-statistic>
      </div>
      <div nz-col [nzSpan]="6">
        <nz-statistic
          [nzValue]="priceStats.highestPrice"
          [nzTitle]="'Highest Price'"
          [nzFormatter]="formatCurrency"
          [nzValueStyle]="{ color: '#f5222d' }">
        </nz-statistic>
      </div>
      <div nz-col [nzSpan]="6">
        <nz-statistic
          [nzValue]="priceStats.averagePrice"
          [nzTitle]="'Average Price'"
          [nzFormatter]="formatCurrency">
        </nz-statistic>
      </div>
    </div>
  </nz-card>

  <!-- Filters -->
  <nz-card nzSize="small" class="filters-card">
    <div nz-row [nzGutter]="16">
      <div nz-col [nzSpan]="6">
        <nz-form-item>
          <nz-form-label>Time Range</nz-form-label>
          <nz-form-control>
            <nz-select [(ngModel)]="selectedTimeRange" (ngModelChange)="onTimeRangeChange()">
              <nz-option
                *ngFor="let option of timeRangeOptions"
                [nzLabel]="option.label"
                [nzValue]="option.value">
              </nz-option>
            </nz-select>
          </nz-form-control>
        </nz-form-item>
      </div>

      <div nz-col [nzSpan]="6">
        <nz-form-item>
          <nz-form-label>Seller</nz-form-label>
          <nz-form-control>
            <nz-select [(ngModel)]="selectedSeller" (ngModelChange)="onSellerChange()" nzAllowClear nzPlaceHolder="All Sellers">
              <nz-option
                *ngFor="let seller of availableSellers"
                [nzLabel]="seller"
                [nzValue]="seller">
              </nz-option>
            </nz-select>
          </nz-form-control>
        </nz-form-item>
      </div>

      <div nz-col [nzSpan]="6" *ngIf="selectedTimeRange === 'custom'">
        <nz-form-item>
          <nz-form-label>Start Date</nz-form-label>
          <nz-form-control>
            <nz-date-picker
              [(ngModel)]="startDate"
              (ngModelChange)="onCustomDateChange()"
              nzFormat="yyyy-MM-dd">
            </nz-date-picker>
          </nz-form-control>
        </nz-form-item>
      </div>

      <div nz-col [nzSpan]="6" *ngIf="selectedTimeRange === 'custom'">
        <nz-form-item>
          <nz-form-label>End Date</nz-form-label>
          <nz-form-control>
            <nz-date-picker
              [(ngModel)]="endDate"
              (ngModelChange)="onCustomDateChange()"
              nzFormat="yyyy-MM-dd">
            </nz-date-picker>
          </nz-form-control>
        </nz-form-item>
      </div>
    </div>
  </nz-card>

  <!-- Price Chart -->
  <nz-card nzSize="small" class="chart-card" *ngIf="showChart" [nzLoading]="chartLoading">
    <div class="chart-container" *ngIf="chartData.length > 0; else noChartData">
      <!-- Chart would be rendered here with a charting library like ECharts -->
      <div class="chart-placeholder">
        <nz-icon nzType="line-chart" nzTheme="outline"></nz-icon>
        <p>Price History Chart</p>
        <p class="chart-note">Chart rendering requires ECharts integration</p>
      </div>
    </div>
    <ng-template #noChartData>
      <nz-empty nzNotFoundContent="No chart data available"></nz-empty>
    </ng-template>
  </nz-card>

  <!-- Price Comparison -->
  <nz-card nzSize="small" class="comparison-card" *ngIf="priceComparison.length > 0">
    <div class="card-header">
      <h4>Current Price Comparison</h4>
    </div>
    <div nz-row [nzGutter]="16">
      <div nz-col [nzSpan]="8" *ngFor="let item of priceComparison">
        <div class="comparison-item">
          <div class="seller-name">{{ item.seller }}</div>
          <div class="price">{{ formatCurrency(item.currentPrice) }}</div>
          <div class="price-change" [ngClass]="getPriceChangeClass(item.priceChange)">
            <nz-icon [nzType]="getPriceChangeIcon(item.priceChange)" nzTheme="outline"></nz-icon>
            {{ item.priceChange > 0 ? '+' : '' }}{{ formatCurrency(item.priceChange) }}
          </div>
          <div class="last-updated">{{ item.lastUpdated | date:'short' }}</div>
        </div>
      </div>
    </div>
  </nz-card>

  <!-- Price History Table -->
  <nz-card nzSize="small" class="table-card">
    <div class="card-header">
      <h4>Detailed History</h4>
    </div>

    <nz-table
      #historyTable
      [nzData]="priceHistory"
      [nzLoading]="loading"
      [nzTotal]="total"
      [nzPageSize]="pageSize"
      [nzPageIndex]="pageIndex"
      [nzShowSizeChanger]="true"
      [nzPageSizeOptions]="['10', '20', '50', '100']"
      (nzQueryParams)="onPageChange($event.pageIndex)"
      nzSize="small">

      <thead>
        <tr>
          <th>Date</th>
          <th>Seller</th>
          <th>Price</th>
          <th>Change</th>
          <th>Currency</th>
          <th>Source URL</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let entry of priceHistory">
          <td>{{ entry.scrapedAt | date:'medium' }}</td>
          <td>
            <nz-tag [nzColor]="'blue'">{{ entry.sellerName }}</nz-tag>
          </td>
          <td>
            <strong>{{ formatCurrency(entry.price) }}</strong>
          </td>
          <td>
            <span
              *ngIf="entry.priceChange !== undefined"
              [ngClass]="getPriceChangeClass(entry.priceChange)">
              <nz-icon [nzType]="getPriceChangeIcon(entry.priceChange)" nzTheme="outline"></nz-icon>
              {{ entry.priceChange > 0 ? '+' : '' }}{{ formatCurrency(entry.priceChange) }}
            </span>
            <span *ngIf="entry.priceChange === undefined">-</span>
          </td>
          <td>{{ entry.currency }}</td>
          <td>
            <a
              *ngIf="entry.sourceUrl"
              [href]="entry.sourceUrl"
              target="_blank"
              rel="noopener noreferrer">
              <nz-icon nzType="link" nzTheme="outline"></nz-icon>
              View
            </a>
            <span *ngIf="!entry.sourceUrl">-</span>
          </td>
        </tr>
      </tbody>
    </nz-table>
  </nz-card>

  <!-- Empty State -->
  <nz-card *ngIf="!loading && priceHistory.length === 0" nzSize="small">
    <nz-empty
      nzNotFoundContent="No price history found"
      nzNotFoundImage="/assets/images/empty-chart.svg">
      <span nz-empty-footer>
        <button nz-button nzType="primary" (click)="loadInitialData()">
          <nz-icon nzType="reload" nzTheme="outline"></nz-icon>
          Refresh
        </button>
      </span>
    </nz-empty>
  </nz-card>
</div>
