<div class="user-list-container">
  <nz-card nzTitle="User Management" [nzExtra]="extraTemplate">
    <!-- Search and Filters -->
    <div class="search-filters-section">
      <div nz-row [nzGutter]="16" class="mb-4">
        <div nz-col [nzSpan]="8">
          <nz-input-group [nzSuffix]="suffixIconSearch">
            <input
              type="text"
              nz-input
              placeholder="Search users..."
              [(ngModel)]="searchValue"
              (ngModelChange)="onSearchChange()"
              (keyup.enter)="onSearch()"
            />
          </nz-input-group>
          <ng-template #suffixIconSearch>
            <span nz-icon nzType="search" (click)="onSearch()"></span>
          </ng-template>
        </div>

        <div nz-col [nzSpan]="4">
          <nz-select
            nzPlaceHolder="Status"
            nzAllowClear
            [(ngModel)]="activeFilter"
            (ngModelChange)="onFilterChange()"
            style="width: 100%"
          >
            <nz-option [nzValue]="true" nzLabel="Active"></nz-option>
            <nz-option [nzValue]="false" nzLabel="Inactive"></nz-option>
          </nz-select>
        </div>

        <div nz-col [nzSpan]="4">
          <nz-select
            nzPlaceHolder="Email Verified"
            nzAllowClear
            [(ngModel)]="emailConfirmedFilter"
            (ngModelChange)="onFilterChange()"
            style="width: 100%"
          >
            <nz-option [nzValue]="true" nzLabel="Verified"></nz-option>
            <nz-option [nzValue]="false" nzLabel="Not Verified"></nz-option>
          </nz-select>
        </div>

        <div nz-col [nzSpan]="4">
          <button nz-button nzType="default" (click)="resetFilters()">
            <span nz-icon nzType="clear"></span>
            Reset Filters
          </button>
        </div>
      </div>
    </div>

    <!-- Users Table -->
    <nz-table
      #basicTable
      [nzData]="users"
      [nzLoading]="loading"
      [nzTotal]="totalCount"
      [nzFrontPagination]="false"
      [nzPageIndex]="currentPage"
      [nzPageSize]="pageSize"
      [nzPageSizeOptions]="pageSizeOptions"
      [nzShowSizeChanger]="true"
      [nzShowTotal]="totalTemplate"
      (nzPageIndexChange)="onPageIndexChange($event)"
      (nzPageSizeChange)="onPageSizeChange($event)"
      nzSize="middle"
    >
      <thead>
        <tr>
          <th nzWidth="200px" nzSortKey="email" (nzSortOrderChange)="onSort({key: 'email', value: $event})">Email</th>
          <th nzWidth="150px" nzSortKey="firstName" (nzSortOrderChange)="onSort({key: 'firstName', value: $event})">Name</th>
          <th nzWidth="120px" nzSortKey="isActive">Status</th>
          <th nzWidth="120px">Email Verified</th>
          <th nzWidth="150px">Roles</th>
          <th nzWidth="120px" nzSortKey="lastLoginAt">Last Login</th>
          <th nzWidth="120px" nzSortKey="createdAt">Created</th>
          <th nzWidth="180px" nzRight>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of users">
          <td>
            <span nz-tooltip [nzTooltipTitle]="user.email">{{ user.email }}</span>
          </td>
          <td>
            {{ (user.firstName && user.lastName) ? (user.firstName + ' ' + user.lastName) : (user.firstName || user.lastName || '-') }}
          </td>
          <td>
            <nz-tag [nzColor]="getStatusColor(user.isActive)">
              {{ getStatusText(user.isActive) }}
            </nz-tag>
          </td>
          <td>
            <nz-tag [nzColor]="user.emailConfirmed ? 'green' : 'orange'">
              {{ user.emailConfirmed ? 'Verified' : 'Pending' }}
            </nz-tag>
          </td>
          <td>
            <span nz-tooltip [nzTooltipTitle]="getRolesDisplay(user.roles)">
              {{ getRolesDisplay(user.roles) }}
            </span>
          </td>
          <td>
            {{ user.lastLoginAt ? formatDate(user.lastLoginAt) : 'Never' }}
          </td>
          <td>
            {{ formatDate(user.createdAt) }}
          </td>
          <td nzRight>
            <nz-button-group>
              <button
                nz-button
                nzType="default"
                nzSize="small"
                nz-tooltip="View Details"
                (click)="viewUser(user.userId)"
              >
                <span nz-icon nzType="eye"></span>
              </button>
              <button
                nz-button
                nzType="default"
                nzSize="small"
                nz-tooltip="Edit User"
                (click)="editUser(user.userId)"
              >
                <span nz-icon nzType="edit"></span>
              </button>
              <button
                nz-button
                nzType="default"
                nzSize="small"
                nz-tooltip="Manage Roles"
                (click)="manageRoles(user.userId)"
              >
                <span nz-icon nzType="team"></span>
              </button>
              <button
                nz-button
                [nzType]="user.isActive ? 'primary' : 'default'"
                nzSize="small"
                [nz-tooltip]="user.isActive ? 'Deactivate User' : 'Activate User'"
                (click)="changeStatus(user)"
              >
                <span nz-icon [nzType]="user.isActive ? 'stop' : 'play-circle'"></span>
              </button>
            </nz-button-group>
          </td>
        </tr>
      </tbody>
    </nz-table>

    <!-- Empty State -->
    <nz-empty *ngIf="!loading && users.length === 0" nzNotFoundContent="No users found"></nz-empty>
  </nz-card>
</div>

<!-- Extra Template for Card Header -->
<ng-template #extraTemplate>
  <button nz-button nzType="primary" (click)="router.navigate(['/users/create'])">
    <span nz-icon nzType="plus"></span>
    Create User
  </button>
</ng-template>

<!-- Total Template for Pagination -->
<ng-template #totalTemplate let-total let-range="range">
  {{ range[0] }}-{{ range[1] }} of {{ total }} users
</ng-template>
