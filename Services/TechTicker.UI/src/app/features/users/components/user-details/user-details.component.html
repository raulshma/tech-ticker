<div class="user-details-container">
  <div class="header-section">
    <button nz-button nzType="default" (click)="goBack()" class="back-button">
      <span nz-icon nzType="arrow-left"></span>
      Back to Users
    </button>

    <div class="header-actions" *ngIf="user">
      <button nz-button nzType="default" (click)="editUser()">
        <span nz-icon nzType="edit"></span>
        Edit User
      </button>
      <button nz-button nzType="primary" (click)="manageRoles()">
        <span nz-icon nzType="team"></span>
        Manage Roles
      </button>
    </div>
  </div>

  <div *ngIf="loading" class="loading-container">
    <nz-spin nzSize="large" nzTip="Loading user details..."></nz-spin>
  </div>

  <div *ngIf="!loading && user" class="content-section">
    <!-- User Profile Card -->
    <nz-card nzTitle="User Profile" class="profile-card">
      <div nz-row [nzGutter]="24">
        <div nz-col [nzSpan]="24" [nzMd]="12">
          <div class="profile-info">
            <div class="profile-avatar">
              <nz-avatar [nzSize]="64" nzIcon="user"></nz-avatar>
              <div class="profile-name">
                <h3>{{ getFullName() }}</h3>
                <p class="email">{{ user.email }}</p>
              </div>
            </div>
          </div>
        </div>
        <div nz-col [nzSpan]="24" [nzMd]="12">
          <div class="status-section">
            <div class="status-item">
              <span class="label">Account Status:</span>
              <nz-tag [nzColor]="getStatusColor(user.isActive)" class="status-tag">
                {{ getStatusText(user.isActive) }}
              </nz-tag>
            </div>
            <div class="status-item">
              <span class="label">Email Status:</span>
              <nz-tag [nzColor]="getEmailStatusColor(user.emailConfirmed)" class="status-tag">
                {{ getEmailStatusText(user.emailConfirmed) }}
              </nz-tag>
            </div>
          </div>
        </div>
      </div>
    </nz-card>

    <!-- User Details Card -->
    <nz-card nzTitle="Account Information" class="details-card">
      <div nz-row [nzGutter]="24">
        <div nz-col [nzSpan]="24" [nzMd]="12">
          <div class="detail-group">
            <h4>Personal Information</h4>
            <div class="detail-item">
              <span class="label">First Name:</span>
              <span class="value">{{ user.firstName || 'Not provided' }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Last Name:</span>
              <span class="value">{{ user.lastName || 'Not provided' }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Email Address:</span>
              <span class="value">{{ user.email }}</span>
            </div>
          </div>
        </div>
        <div nz-col [nzSpan]="24" [nzMd]="12">
          <div class="detail-group">
            <h4>Account Details</h4>
            <div class="detail-item">
              <span class="label">User ID:</span>
              <span class="value">{{ user.userId }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Created:</span>
              <span class="value">{{ formatDate(user.createdAt) }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Last Updated:</span>
              <span class="value">{{ formatDate(user.updatedAt) }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Last Login:</span>
              <span class="value">{{ user.lastLoginAt ? formatDate(user.lastLoginAt) : 'Never logged in' }}</span>
            </div>
          </div>
        </div>
      </div>
    </nz-card>

    <!-- Roles and Permissions Card -->
    <nz-card nzTitle="Roles & Permissions" [nzExtra]="rolesExtraTemplate" class="roles-card">
      <div *ngIf="rolesLoading" class="roles-loading">
        <nz-spin nzTip="Loading roles..."></nz-spin>
      </div>

      <div *ngIf="!rolesLoading">
        <!-- Basic Roles -->
        <div class="roles-section">
          <h4>Assigned Roles</h4>
          <div class="roles-list">
            <nz-tag *ngFor="let role of user.roles" nzColor="blue" class="role-tag">
              {{ role }}
            </nz-tag>
            <span *ngIf="user.roles.length === 0" class="no-data">No roles assigned</span>
          </div>
        </div>

        <!-- Detailed Role Information -->
        <div *ngIf="userRoles.length > 0" class="detailed-roles-section">
          <h4>Role Details</h4>
          <nz-collapse>
            <nz-collapse-panel
              *ngFor="let role of userRoles"
              [nzHeader]="role.name"
              [nzExtra]="roleExtraTemplate"
            >
              <div class="role-details">
                <div *ngIf="role.description" class="role-description">
                  <strong>Description:</strong> {{ role.description }}
                </div>
                <div *ngIf="role.permissions && role.permissions.length > 0" class="role-permissions">
                  <strong>Permissions:</strong>
                  <div class="permissions-list">
                    <nz-tag *ngFor="let permission of role.permissions" nzColor="green" class="permission-tag">
                      {{ permission }}
                    </nz-tag>
                  </div>
                </div>
                <div *ngIf="!role.permissions || role.permissions.length === 0" class="no-permissions">
                  No specific permissions assigned to this role.
                </div>
              </div>
            </nz-collapse-panel>
          </nz-collapse>
        </div>

        <!-- All Permissions Summary -->
        <div *ngIf="hasPermissions()" class="permissions-summary">
          <h4>All Permissions</h4>
          <div class="permissions-grid">
            <nz-tag *ngFor="let permission of getAllPermissions()" nzColor="purple" class="permission-tag">
              {{ permission }}
            </nz-tag>
          </div>
        </div>
      </div>
    </nz-card>
  </div>

  <!-- Error State -->
  <div *ngIf="!loading && !user" class="error-state">
    <nz-result
      nzStatus="404"
      nzTitle="User Not Found"
      nzSubTitle="The user you're looking for doesn't exist or you don't have permission to view it."
    >
      <div nz-result-extra>
        <button nz-button nzType="primary" (click)="goBack()">Back to Users</button>
      </div>
    </nz-result>
  </div>
</div>

<!-- Templates -->
<ng-template #rolesExtraTemplate>
  <button nz-button nzType="default" nzSize="small" (click)="manageRoles()">
    <span nz-icon nzType="setting"></span>
    Manage
  </button>
</ng-template>

<ng-template #roleExtraTemplate>
  <nz-tag nzColor="cyan">Active</nz-tag>
</ng-template>
