<div class="user-roles-container">
  <div class="header-section">
    <div class="breadcrumb-section">
      <nz-breadcrumb>
        <nz-breadcrumb-item>
          <a (click)="goToUsersList()">Users</a>
        </nz-breadcrumb-item>
        <nz-breadcrumb-item>
          <a (click)="goBack()">{{ getFullName() }}</a>
        </nz-breadcrumb-item>
        <nz-breadcrumb-item>Manage Roles</nz-breadcrumb-item>
      </nz-breadcrumb>
    </div>

    <div class="header-actions">
      <button nz-button nzType="default" (click)="goBack()">
        <span nz-icon nzType="arrow-left"></span>
        Back to User
      </button>
    </div>
  </div>

  <div *ngIf="loading" class="loading-container">
    <nz-spin nzSize="large" nzTip="Loading user details..."></nz-spin>
  </div>

  <div *ngIf="!loading && user" class="content-section">
    <!-- User Info Card -->
    <nz-card nzTitle="User Information" class="user-info-card">
      <div nz-row [nzGutter]="24">
        <div nz-col [nzSpan]="24" [nzMd]="16">
          <div class="user-info">
            <div class="user-avatar">
              <nz-avatar [nzSize]="48" nzIcon="user"></nz-avatar>
              <div class="user-details">
                <h3>{{ getFullName() }}</h3>
                <p class="email">{{ user.email }}</p>
                <div class="status-tags">
                  <nz-tag [nzColor]="user.isActive ? 'green' : 'red'">
                    {{ user.isActive ? 'Active' : 'Inactive' }}
                  </nz-tag>
                  <nz-tag [nzColor]="user.emailConfirmed ? 'green' : 'orange'">
                    {{ user.emailConfirmed ? 'Verified' : 'Pending' }}
                  </nz-tag>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div nz-col [nzSpan]="24" [nzMd]="8">
          <div class="role-summary">
            <div class="summary-item">
              <span class="label">Total Roles:</span>
              <span class="value">{{ user.roles.length || 0 }}</span>
            </div>
            <div class="summary-item">
              <span class="label">Last Updated:</span>
              <span class="value">{{ formatDate(user.updatedAt) }}</span>
            </div>
          </div>
        </div>
      </div>
    </nz-card>

    <!-- Assign New Role Card -->
    <nz-card nzTitle="Assign New Role" class="assign-role-card">
      <div class="assign-role-section">
        <div nz-row [nzGutter]="16" nzAlign="bottom">
          <div nz-col [nzFlex]="1">
            <nz-form-item>
              <nz-form-label>Select Role</nz-form-label>
              <nz-form-control>
                <nz-select
                  [(ngModel)]="selectedRoleForAssignment"
                  nzPlaceHolder="Choose a role to assign"
                  nzAllowClear
                  [nzLoading]="availableRolesLoading"
                  style="width: 100%"
                >
                  <nz-option
                    *ngFor="let role of getUnassignedRoles()"
                    [nzValue]="role.name"
                    [nzLabel]="role.name"
                  >
                    <div class="role-option">
                      <div class="role-name">{{ role.name }}</div>
                      <div class="role-desc" *ngIf="role.description">{{ role.description }}</div>
                    </div>
                  </nz-option>
                </nz-select>
              </nz-form-control>
            </nz-form-item>
          </div>
          <div nz-col [nzFlex]="'200px'">
            <button
              nz-button
              nzType="primary"
              [nzLoading]="assigningRole"
              [disabled]="!selectedRoleForAssignment || assigningRole"
              (click)="assignRole()"
            >
              <span nz-icon nzType="plus"></span>
              Assign Role
            </button>
          </div>
        </div>

        <nz-alert
          *ngIf="getUnassignedRoles().length === 0 && !availableRolesLoading"
          nzType="info"
          nzMessage="All Available Roles Assigned"
          nzDescription="This user has been assigned all available roles in the system."
          [nzShowIcon]="true"
          class="no-roles-alert"
        ></nz-alert>
      </div>
    </nz-card>

    <!-- Current Roles Card -->
    <nz-card nzTitle="Current Roles" [nzExtra]="rolesExtraTemplate" class="current-roles-card">
      <div *ngIf="rolesLoading" class="roles-loading">
        <nz-spin nzTip="Loading roles..."></nz-spin>
      </div>

      <div *ngIf="!rolesLoading">
        <div *ngIf="(user?.roles?.length ?? 0) === 0" class="no-roles">
          <nz-empty nzNotFoundContent="No roles assigned">
            <div nz-empty-footer>
              <span>Assign a role using the form above to get started.</span>
            </div>
          </nz-empty>
        </div>

        <div *ngIf="(user?.roles?.length ?? 0) > 0" class="roles-list">
          <div *ngFor="let roleName of user?.roles || []" class="role-item">
            <nz-card nzSize="small" class="role-card">
              <div class="role-header">
                <div class="role-info">
                  <h4 class="role-title">{{ roleName }}</h4>
                  <p class="role-description">{{ getRoleDescription(roleName) }}</p>
                </div>
                <div class="role-actions">
                  <button
                    nz-button
                    nzType="primary"
                    nzDanger
                    nzSize="small"
                    [nzLoading]="removingRole"
                    [disabled]="removingRole || !canRemoveRole(roleName)"
                    (click)="removeRole(roleName)"
                    nz-tooltip="Remove this role"
                  >
                    <span nz-icon nzType="minus"></span>
                    Remove
                  </button>
                </div>
              </div>

              <div *ngIf="hasRolePermissions(roleName)" class="role-permissions">
                <h5>Permissions:</h5>
                <div class="permissions-list">
                  <nz-tag
                    *ngFor="let permission of getRolePermissions(roleName)"
                    nzColor="green"
                    class="permission-tag"
                  >
                    {{ permission }}
                  </nz-tag>
                </div>
              </div>

              <div *ngIf="!hasRolePermissions(roleName)" class="no-permissions">
                <span class="no-permissions-text">No specific permissions assigned</span>
              </div>
            </nz-card>
          </div>
        </div>
      </div>
    </nz-card>

    <!-- Role Management Info -->
    <nz-card nzTitle="Role Management Information" class="info-card">
      <div class="info-content">
        <nz-alert
          nzType="info"
          nzMessage="Role Management Guidelines"
          [nzDescription]="roleGuidelinesTemplate"
          [nzShowIcon]="true"
        ></nz-alert>
      </div>
    </nz-card>
  </div>

  <!-- Error State -->
  <div *ngIf="!loading && !user" class="error-state">
    <nz-result
      nzStatus="404"
      nzTitle="User Not Found"
      nzSubTitle="The user you're trying to manage roles for doesn't exist or you don't have permission to access it."
    >
      <div nz-result-extra>
        <button nz-button nzType="primary" (click)="goToUsersList()">Back to Users</button>
      </div>
    </nz-result>
  </div>
</div>

<!-- Templates -->
<ng-template #rolesExtraTemplate>
  <span class="roles-count">{{ user?.roles?.length ?? 0 }} role(s)</span>
</ng-template>

<ng-template #roleGuidelinesTemplate>
  <ul class="guidelines-list">
    <li>Roles define what actions a user can perform in the system</li>
    <li>Users can have multiple roles, and permissions are cumulative</li>
    <li>Some system roles may have restrictions on removal</li>
    <li>Role changes take effect immediately after assignment or removal</li>
    <li>Always ensure users have appropriate roles for their responsibilities</li>
  </ul>
</ng-template>
