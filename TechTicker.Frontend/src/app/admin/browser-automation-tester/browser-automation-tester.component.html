<div class="browser-automation-tester">
  <!-- Header with test controls -->
  <mat-toolbar class="test-toolbar">
    <mat-form-field class="url-input">
      <mat-label>Test URL</mat-label>
      <input matInput 
             formControlName="testUrl"
             placeholder="https://example.com/product">
    </mat-form-field>
    
    <button mat-raised-button 
            color="primary" 
            [disabled]="isTestRunning" 
            (click)="startTest()">
      <mat-icon>play_arrow</mat-icon>
      Start Test
    </button>
    
    <button mat-raised-button 
            color="warn" 
            [disabled]="!isTestRunning" 
            (click)="stopTest()">
      <mat-icon>stop</mat-icon>
      Stop Test
    </button>
    
    <!-- Phase 2: Enhanced controls -->
    <button mat-raised-button 
            color="accent" 
            (click)="openAdvancedSettings()"
            [disabled]="isTestRunning"
            matTooltip="Advanced Configuration">
      <mat-icon>tune</mat-icon>
      Advanced
    </button>
    
    <button mat-icon-button 
            [matMenuTriggerFor]="exportMenu"
            [disabled]="!testResults && logs.length === 0"
            matTooltip="Export Options">
      <mat-icon>download</mat-icon>
    </button>
    
    <button mat-icon-button 
            [matMenuTriggerFor]="settingsMenu"
            matTooltip="Quick Settings">
      <mat-icon>settings</mat-icon>
    </button>
  </mat-toolbar>

  <!-- Phase 2: Export Menu -->
  <mat-menu #exportMenu="matMenu">
    <button mat-menu-item (click)="exportTestData('json')">
      <mat-icon>description</mat-icon>
      Export as JSON
    </button>
    <button mat-menu-item (click)="exportTestData('csv')">
      <mat-icon>table_chart</mat-icon>
      Export as CSV
    </button>
    <button mat-menu-item (click)="exportTestData('pdf')" disabled>
      <mat-icon>picture_as_pdf</mat-icon>
      Export as PDF (Coming Soon)
    </button>
    <mat-divider></mat-divider>
    <button mat-menu-item (click)="captureScreenshot()" [disabled]="!currentSessionId">
      <mat-icon>camera_alt</mat-icon>
      Capture Screenshot
    </button>
  </mat-menu>

  <!-- Enhanced main content area with resizable panels -->
  <div class="test-content" cdkDropListGroup>
    <!-- Left panel: Profile configuration -->
    <mat-card class="profile-panel">
      <mat-card-header>
        <mat-card-title>Automation Profile</mat-card-title>
        <mat-card-subtitle>Configure browser automation actions</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <!-- Profile configuration would go here -->
        <div class="profile-placeholder">
          <p>Browser automation profile configuration will be displayed here.</p>
          <p>This integrates with the existing profile builder component.</p>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Center panel: Live browser view -->
    <mat-card class="browser-panel" [class.fullscreen]="browserFullscreen">
      <mat-card-header>
        <mat-card-title>Live Browser View</mat-card-title>
        <div class="browser-controls">
          <button mat-icon-button (click)="toggleFullscreen()" [matTooltip]="browserFullscreen ? 'Exit Fullscreen' : 'Fullscreen'">
            <mat-icon>{{browserFullscreen ? 'fullscreen_exit' : 'fullscreen'}}</mat-icon>
          </button>
          <button mat-icon-button (click)="captureScreenshot()" [matTooltip]="'Capture Screenshot'">
            <mat-icon>camera_alt</mat-icon>
          </button>
        </div>
      </mat-card-header>
      <mat-card-content>
        <div class="browser-viewport">
          <!-- Browser frame -->
          <div class="browser-frame">
            <!-- Address bar -->
            <div class="address-bar">
              <mat-icon class="security-icon" [class.secure]="currentScreenshot">
                {{currentScreenshot ? 'lock' : 'lock_open'}}
              </mat-icon>
              <span class="current-url">{{browserState?.currentUrl || 'about:blank'}}</span>
              <mat-spinner *ngIf="isTestRunning" diameter="16"></mat-spinner>
            </div>
            
            <!-- Page content -->
            <div class="page-content">
              <img [src]="'data:image/png;base64,' + currentScreenshot" 
                   *ngIf="currentScreenshot"
                   class="browser-screenshot"
                   [alt]="'Browser screenshot'">
              
              <!-- Loading overlay -->
              <div class="loading-overlay" *ngIf="isTestRunning && !currentScreenshot">
                <mat-spinner></mat-spinner>
                <p>{{currentAction || 'Initializing test...'}}</p>
              </div>
              
              <!-- Placeholder when no test is running -->
              <div class="browser-placeholder" *ngIf="!isTestRunning && !currentScreenshot">
                <mat-icon class="placeholder-icon">web</mat-icon>
                <h3>Browser Automation Tester</h3>
                <p>Start a test to see live browser automation</p>
              </div>
            </div>
          </div>
          
          <!-- Progress bar -->
          <mat-progress-bar 
            mode="determinate" 
            [value]="testProgress"
            class="test-progress"
            *ngIf="isTestRunning">
          </mat-progress-bar>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Right panel: Tabs for logs, metrics, and test results -->
    <mat-card class="info-panel">
      <mat-tab-group [(selectedIndex)]="selectedTab" animationDuration="200ms">
        <mat-tab label="Execution Logs">
          <div class="tab-content">
            <div class="logs-header">
              <div class="logs-stats">
                <span class="log-count">{{logs.length}} entries</span>
                <span class="error-count" *ngIf="hasErrors" [matBadge]="errorLogCount" matBadgeColor="warn">
                  <mat-icon class="error-icon">error</mat-icon>
                </span>
              </div>
              <div class="logs-actions">
                <button mat-icon-button (click)="clearLogs()" [matTooltip]="'Clear Logs'">
                  <mat-icon>clear_all</mat-icon>
                </button>
                <button mat-icon-button (click)="exportLogs()" [matTooltip]="'Export Logs'">
                  <mat-icon>download</mat-icon>
                </button>
                <mat-slide-toggle [(ngModel)]="autoScroll" class="auto-scroll-toggle">
                  Auto-scroll
                </mat-slide-toggle>
              </div>
            </div>
            
            <div class="logs-container" #logsContainer>
              <div class="log-entry" 
                   *ngFor="let log of logs; trackBy: trackByLogIndex"
                   [class]="'log-' + log.level">
                <div class="log-header">
                  <mat-icon class="log-icon" [class]="getLogLevelClass(log.level)">
                    {{getLogLevelIcon(log.level)}}
                  </mat-icon>
                  <span class="log-timestamp">{{formatTimestamp(log.timestamp)}}</span>
                  <span class="log-level">{{log.level.toUpperCase()}}</span>
                  <span class="log-category" *ngIf="log.category">[{{log.category}}]</span>
                </div>
                <div class="log-message">{{log.message}}</div>
                <div class="log-details" *ngIf="log.details">
                  <pre>{{log.details | json}}</pre>
                </div>
              </div>
              
              <div class="no-logs" *ngIf="logs.length === 0">
                <mat-icon>list_alt</mat-icon>
                <p>No log entries yet. Start a test to see execution logs.</p>
              </div>
            </div>
          </div>
        </mat-tab>
        
        <mat-tab label="Performance">
          <div class="tab-content">
            <div class="metrics-grid" *ngIf="metrics">
              <div class="metric-card">
                <mat-icon class="metric-icon">timer</mat-icon>
                <div class="metric-content">
                  <div class="metric-value">{{formatDuration(metrics.executionTime || 0)}}</div>
                  <div class="metric-label">Execution Time</div>
                </div>
              </div>
              
              <div class="metric-card">
                <mat-icon class="metric-icon">memory</mat-icon>
                <div class="metric-content">
                  <div class="metric-value">{{(metrics.memoryUsage || 0).toFixed(1)}} MB</div>
                  <div class="metric-label">Memory Usage</div>
                </div>
              </div>
              
              <div class="metric-card">
                <mat-icon class="metric-icon">network_check</mat-icon>
                <div class="metric-content">
                  <div class="metric-value">{{networkRequests.length}}</div>
                  <div class="metric-label">Network Requests</div>
                </div>
              </div>
              
              <div class="metric-card">
                <mat-icon class="metric-icon">code</mat-icon>
                <div class="metric-content">
                  <div class="metric-value">{{consoleMessages.length}}</div>
                  <div class="metric-label">Console Messages</div>
                </div>
              </div>
            </div>
            
            <div class="no-metrics" *ngIf="!metrics">
              <mat-icon>analytics</mat-icon>
              <p>No performance metrics available. Start a test to see real-time metrics.</p>
            </div>
          </div>
        </mat-tab>
        
        <mat-tab label="Network">
          <div class="tab-content">
            <div class="network-requests" *ngIf="networkRequests.length > 0">
              <mat-expansion-panel *ngFor="let request of networkRequests; trackBy: trackByLogIndex" class="request-panel">
                <mat-expansion-panel-header>
                  <mat-panel-title>
                    <span class="request-method" [class]="'method-' + (request.method || 'unknown').toLowerCase()">
                      {{request.method || 'UNKNOWN'}}
                    </span>
                    <span class="request-url">{{request.url}}</span>
                  </mat-panel-title>
                  <mat-panel-description>
                    <span class="request-status" [class]="'status-' + Math.floor((request.status || 0) / 100)">
                      {{request.status || 'Pending'}}
                    </span>
                    <span class="request-timing">{{request.duration || 0}}ms</span>
                  </mat-panel-description>
                </mat-expansion-panel-header>
                
                <div class="request-details">
                  <div class="request-headers" *ngIf="request.headers">
                    <h4>Headers</h4>
                    <pre>{{request.headers | json}}</pre>
                  </div>
                  <div class="request-response" *ngIf="request.response">
                    <h4>Response</h4>
                    <pre>{{request.response | json}}</pre>
                  </div>
                </div>
              </mat-expansion-panel>
            </div>
            
            <div class="no-network" *ngIf="networkRequests.length === 0">
              <mat-icon>network_check</mat-icon>
              <p>No network requests captured yet. Start a test to monitor network activity.</p>
            </div>
          </div>
        </mat-tab>
        
        <mat-tab label="Console">
          <div class="tab-content">
            <div class="console-messages" *ngIf="consoleMessages.length > 0">
              <div class="console-entry" 
                   *ngFor="let message of consoleMessages; trackBy: trackByLogIndex"
                   [class]="'console-' + (message.level || 'log')">
                <div class="console-header">
                  <mat-icon class="console-icon" [class]="getLogLevelClass(message.level || 'info')">
                    {{getLogLevelIcon(message.level || 'info')}}
                  </mat-icon>
                  <span class="console-timestamp">{{formatTimestamp(message.timestamp)}}</span>
                  <span class="console-level">{{(message.level || 'log').toUpperCase()}}</span>
                </div>
                <div class="console-text">{{message.text}}</div>
                <div class="console-details" *ngIf="message.args && message.args.length > 0">
                  <pre>{{message.args | json}}</pre>
                </div>
              </div>
            </div>
            
            <div class="no-console" *ngIf="consoleMessages.length === 0">
              <mat-icon>code</mat-icon>
              <p>No console messages captured yet. Start a test to monitor browser console output.</p>
            </div>
          </div>
        </mat-tab>

        <!-- Test Results Management Tab -->
        <mat-tab label="Test Results" [matBadge]="savedResultsCount > 0 ? savedResultsCount : null" matBadgeSize="small" matBadgePosition="after">
          <div class="tab-content test-results-tab">
            <!-- Test Results History Component -->
            <app-test-results-history></app-test-results-history>
          </div>
        </mat-tab>
      </mat-tab-group>
    </mat-card>
  </div>

  <!-- Enhanced bottom panel: Test results and actions -->
  <mat-card class="results-panel" *ngIf="hasTestResults">
    <mat-card-header>
      <mat-icon [class]="isTestSuccessful ? 'success' : 'error'" class="result-icon">
        {{testResultIcon}}
      </mat-icon>
      <mat-card-title>{{testResultTitle}}</mat-card-title>
      <mat-card-subtitle>
        Executed {{testActionsExecuted}} actions in {{formatDuration(testDuration)}}
        <span *ngIf="hasTestErrors"> â€¢ {{testErrorCount}} errors</span>
      </mat-card-subtitle>
      <div class="result-actions">
        <button mat-raised-button 
                color="primary"
                (click)="saveResults()"
                [disabled]="!hasTestResults">
          <mat-icon>save</mat-icon>
          Save Results
        </button>
        <button mat-button (click)="exportTestData('json')">
          <mat-icon>download</mat-icon>
          Export JSON
        </button>
        <button mat-button (click)="exportTestData('csv')">
          <mat-icon>table_chart</mat-icon>
          Export CSV
        </button>
        <button mat-button (click)="exportTestData('pdf')">
          <mat-icon>picture_as_pdf</mat-icon>
          Export PDF
        </button>
        <button mat-button (click)="shareResults()">
          <mat-icon>share</mat-icon>
          Share
        </button>
      </div>
    </mat-card-header>
    <mat-card-content>
      <!-- Test results summary -->
      <div class="results-summary">
        <div class="summary-item">
          <mat-icon>play_arrow</mat-icon>
          <span>{{testActionsExecuted}} Actions</span>
        </div>
        <div class="summary-item">
          <mat-icon>timer</mat-icon>
          <span>{{formatDuration(testDuration)}}</span>
        </div>
        <div class="summary-item" *ngIf="testErrorCount > 0">
          <mat-icon class="error">error</mat-icon>
          <span>{{testErrorCount}} Errors</span>
        </div>
        <div class="summary-item" *ngIf="isTestSuccessful">
          <mat-icon class="success">check_circle</mat-icon>
          <span>Success</span>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
</div>

<!-- Settings menu -->
<mat-menu #settingsMenu="matMenu" class="settings-menu">
  <div class="config-section" (click)="stopPropagation($event)">
    <h3>Browser Settings</h3>
    <mat-slide-toggle [(ngModel)]="testOptions.headless">
      Headless Mode
    </mat-slide-toggle>
    
    <mat-form-field>
      <mat-label>Slow Motion (ms)</mat-label>
      <input matInput type="number" [(ngModel)]="testOptions.slowMotion" min="0" max="5000">
      <mat-hint>Delay between actions for better visualization</mat-hint>
    </mat-form-field>
    
    <mat-slide-toggle [(ngModel)]="testOptions.recordVideo">
      Record Video
    </mat-slide-toggle>
    
    <mat-slide-toggle [(ngModel)]="testOptions.captureScreenshots">
      Capture Screenshots
    </mat-slide-toggle>
    
    <h3>Logging Settings</h3>
    <mat-slide-toggle [(ngModel)]="testOptions.enableNetworkLogging">
      Network Logging
    </mat-slide-toggle>
    
    <mat-slide-toggle [(ngModel)]="testOptions.enableConsoleLogging">
      Console Logging
    </mat-slide-toggle>
    
    <mat-slide-toggle [(ngModel)]="testOptions.enablePerformanceLogging">
      Performance Logging
    </mat-slide-toggle>
    
    <h3>Timeout Settings</h3>
    <mat-form-field>
      <mat-label>Test Timeout (ms)</mat-label>
      <input matInput type="number" [(ngModel)]="testOptions.testTimeoutMs">
    </mat-form-field>
    
    <mat-form-field>
      <mat-label>Action Timeout (ms)</mat-label>
      <input matInput type="number" [(ngModel)]="testOptions.actionTimeoutMs">
    </mat-form-field>
    
    <mat-form-field>
      <mat-label>Navigation Timeout (ms)</mat-label>
      <input matInput type="number" [(ngModel)]="testOptions.navigationTimeoutMs">
    </mat-form-field>
  </div>
</mat-menu> 